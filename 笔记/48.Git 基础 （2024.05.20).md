# Git 基础 （2024.05.20）

---

## 1. Git 简介

### 1.1 什么是 Git？

Git 是一个**分布式版本控制系统**，用于跟踪文件的变化，协调多人协作开发。

### 1.2 为什么要使用 Git？

| 场景 | 没有 Git | 使用 Git |
|------|----------|----------|
| 版本备份 | 手动复制文件夹（v1、v2、v3...） | 自动记录每次修改 |
| 多人协作 | 通过U盘/邮件传递，容易冲突 | 自动合并，冲突可控 |
| 代码回退 | 找不到之前的版本 | 随时回退到任意版本 |
| 追溯问题 | 不知道谁改了什么 | 完整的修改历史记录 |

### 1.3 Git vs SVN

```
┌─────────────────────────────────────────────────────────┐
│  SVN（集中式）              Git（分布式）               │
│                                                         │
│      ┌─────┐                    ┌─────┐                 │
│      │服务器│                    │服务器│               │
│      └──┬──┘                    └──┬──┘                 │
│         │                          │                    │
│    ┌────┼────┐              ┌─────┼─────┐               │
│    ▼    ▼    ▼              ▼     ▼     ▼               │
│   开发者(无完整历史)        开发者(完整仓库副本)        │
└─────────────────────────────────────────────────────────┘
```

---

## 2. 环境准备

### 2.1 安装 Git

**Windows:**

```bash
# 下载地址：https://git-scm.com/download/win
# 安装时保持默认选项即可
```

### 2.2 验证安装

```bash
git --version
```

### 2.3 初始配置（非常重要）

```bash
# 设置用户名（使用你的真实姓名）
git config --global user.name "张三"

# 设置邮箱（使用公司邮箱）
git config --global user.email "zhangsan@company.com"

# 查看配置
git config --list
```

### 2.4 配置 SSH 密钥（推荐）

```bash
# 1. 生成 SSH 密钥
ssh-keygen -t rsa -b 4096 -C "zhangsan@company.com"
# 一路回车使用默认设置

# 2. 查看公钥
cat ~/.ssh/id_rsa.pub

# 3. 将公钥添加到 GitLab/GitHub 的 SSH Keys 设置中
```

---

## 3. 基础概念

### 3.1 Git 的三个区域

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  工作区                                                     │
│  ├── 你能看到的项目文件夹                                   │
│  └── 在这里编写代码                                         │
│         │                                                   │
│         │ git add                                           │
│         ▼                                                   │
│  暂存区                                                     │
│  ├── 临时存储区域                                           │
│  └── 准备提交的文件                                         │
│         │                                                   │
│         │ git commit                                        │
│         ▼                                                   │
│  本地仓库                                                   │
│  ├── .git 目录中                                            │
│  └── 完整的版本历史                                         │
│         │                                                   │
│         │ git push                                          │
│         ▼                                                   │
│  远程仓库                                                   │
│  └── GitLab / GitHub 服务器上                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 文件的四种状态

```
┌───────────────────────────────────────────────────────────┐
│                                                           │
│  Untracked ──────git add──────▶ Staged                    │
│  (未跟踪)                        (已暂存)                 │
│                                     │                     │
│                                git commit                 │
│                                     │                     │
│                                     ▼                     │
│  Modified ◀─────修改文件────── Unmodified                 │
│  (已修改)                       (未修改)                  │
│      │                                                    │
│   git add                                                 │
│      │                                                    │
│      ▼                                                    │
│   Staged ─────git commit─────▶ Unmodified                 │
│                                                           │
└───────────────────────────────────────────────────────────┘
```

---

## 4. 基本操作

### 4.1 创建仓库

**方式一：初始化新仓库**

```bash
# 创建项目目录
mkdir my-project
cd my-project

# 初始化 Git 仓库
git init
```

**方式二：克隆现有仓库**

```bash
# 克隆远程仓库到本地
git clone git@gitlab.company.com:team/project.git

# 克隆到指定目录
git clone git@gitlab.company.com:team/project.git my-folder
```

### 4.2 查看状态

```bash
# 查看当前状态
git status

# 简洁模式
git status -s
```

**状态说明：**

```
?? file.txt    # 未跟踪的新文件
A  file.txt    # 新添加到暂存区
M  file.txt    # 已修改（在暂存区）
 M file.txt    # 已修改（在工作区）
D  file.txt    # 已删除
```

### 4.3 添加文件到暂存区

```bash
# 添加单个文件
git add filename.txt

# 添加多个文件
git add file1.txt file2.txt

# 添加当前目录所有文件
git add .

# 添加所有 .java 文件
git add *.java

# 交互式添加
git add -p
```

### 4.4 提交更改

```bash
# 提交
git commit

# 提交并附带信息
git commit -m "feat: 添加用户登录功能"

# 添加并提交已跟踪的文件
git commit -am "fix: 修复登录验证bug"
```

### 4.5 查看提交历史

```bash
# 查看完整历史
git log

# 简洁模式
git log --oneline

# 图形化显示分支
git log --oneline --graph --all

# 查看最近 5 条
git log -5

# 查看某个文件的历史
git log filename.txt

# 查看详细修改内容
git log -p
```

### 4.6 查看差异

```bash
# 查看工作区和暂存区的差异
git diff

# 查看暂存区和最后一次提交的差异
git diff --staged

# 查看两个提交之间的差异
git diff commit1 commit2

# 查看某个文件的差异
git diff filename.txt
```

### 4.7 撤销操作

```bash
# 撤销工作区的修改
git checkout -- filename.txt
# 或
git restore filename.txt

# 取消暂存
git reset HEAD filename.txt
# 或
git restore --staged filename.txt

# 修改最后一次提交
git commit --amend -m "新的提交信息"
```

---

## 5. 分支管理

### 5.1 分支概念图解

```
                     feature/login
                         │
                         ▼
              ○────○────○
             /            
────○────○────○────○────○────○──── main
                    \           /
                     ○────○────○
                         ▲
                         │
                   feature/register
```

### 5.2 分支基本操作

```bash
# 查看本地分支
git branch

# 查看所有分支（包括远程）
git branch -a

# 创建新分支
git branch feature/login

# 切换分支
git checkout feature/login
# 或
git switch feature/login

# 创建并切换分支
git checkout -b feature/login
# 或
git switch -c feature/login

# 删除分支
git branch -d feature/login

# 强制删除未合并的分支
git branch -D feature/login

# 重命名分支
git branch -m old-name new-name
```

### 5.3 分支合并

```bash
# 假设要将 feature/login 合并到 main

# 1. 先切换到目标分支
git checkout main

# 2. 执行合并
git merge feature/login

# 合并时创建合并提交（推荐）
git merge --no-ff feature/login -m "合并登录功能分支"
```

**合并示意图：**

```
# Fast-forward 合并（默认）
      feature                     feature
         │                           │
before:  ○────○────○     after:  ○────○────○
        /                       /         │
───○───○                   ───○───────────○ main
       │                              
     main                             

# --no-ff 合并（推荐）
      feature                     feature
         │                           │
before:  ○────○────○     after:  ○────○────○
        /                       /           \
───○───○                   ───○──────────────○ main
       │                                     │
     main                             合并提交(merge commit)
```

### 5.4 解决冲突

当两个分支修改了同一文件的同一位置时，会产生冲突：

```bash
# 合并时发生冲突
git merge feature/login
# Auto-merging file.txt
# CONFLICT (content): Merge conflict in file.txt
```

**冲突文件内容示例：**

```
<<<<<<< HEAD
这是 main 分支的内容
=======
这是 feature/login 分支的内容
>>>>>>> feature/login
```

**解决步骤：**

```bash
# 1. 手动编辑冲突文件，保留需要的内容，删除标记符号

# 2. 将解决后的文件添加到暂存区
git add file.txt

# 3. 完成合并提交
git commit -m "解决合并冲突"
```

### 5.5 变基（Rebase）

```bash
# 将当前分支变基到 main
git rebase main

# 交互式变基（可修改、合并、删除提交）
git rebase -i HEAD~3
```

**Merge vs Rebase：**

```
# Merge：保留完整历史
───○───○───────────○───  main
        \         /
         ○───○───○       feature

# Rebase：线性历史
───○───○───○───○───○───  main
              ↑
        feature 的提交被"移动"到这里
```

⚠️ **注意**：不要对已推送的公共分支执行 rebase！

---

## 6. 远程仓库操作

### 6.1 远程仓库管理

```bash
# 查看远程仓库
git remote -v

# 添加远程仓库
git remote add origin git@gitlab.company.com:team/project.git

# 修改远程仓库地址
git remote set-url origin new-url

# 删除远程仓库关联
git remote remove origin
```

### 6.2 推送代码

```bash
# 推送到远程分支
git push origin main

# 首次推送并建立追踪关系
git push -u origin main

# 之后可以简写
git push

# 推送所有分支
git push --all origin

# 强制推送（危险！会覆盖远程）
git push -f origin main
```

### 6.3 拉取代码

```bash
# 拉取并自动合并（常用）
git pull

# 等同于
git fetch + git merge

# 拉取但不合并
git fetch origin

# 拉取后变基（保持线性历史）
git pull --rebase
```

### 6.4 远程分支操作

```bash
# 查看远程分支
git branch -r

# 拉取远程分支到本地
git checkout -b feature/login origin/feature/login
# 或简写
git checkout feature/login

# 删除远程分支
git push origin --delete feature/login

# 清理已删除的远程分支引用
git fetch --prune
```

---

## 7. 团队协作流程

### 7.1 Git Flow 工作流

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  main ──●────────────────●────────────────●──────────    │
│            \              / \              /                │
│  release    \────────────●   \────────────●                 │
│              \          /     \          /                  │
│  develop ─────●────●───●───────●────●───●──────────        │
│               \   /             \   /                       │
│  feature       ●─●               ●─●                        │
│                                                             │
│  分支说明：                                                  │
│  • main:  生产环境代码                                     │
│  • develop: 开发主分支                                       │
│  • feature: 功能开发分支                                     │
│  • release: 发版预备分支                                     │
│  • hotfix:  紧急修复分支                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 日常开发流程

```bash
# 1. 开始新功能开发
git checkout develop
git pull origin develop
git checkout -b feature/user-profile

# 2. 开发过程中，定期提交
git add .
git commit -m "feat: 添加用户头像上传功能"

# 3. 开发完成，推送分支
git push -u origin feature/user-profile

# 4. 在 GitLab/GitHub 创建 Merge Request / Pull Request

# 5. Code Review 通过后，合并到 develop

# 6. 删除本地和远程的功能分支
git checkout develop
git branch -d feature/user-profile
git push origin --delete feature/user-profile
```

### 7.3 代码审查（Code Review）流程

```
1. 开发者提交 MR/PR
         │
         ▼
2. 自动化检查（CI/CD）
         │
         ▼
3. 同事审查代码
    ├── 通过 → 合并
    └── 不通过 → 修改后重新审查
```

---

## 8. 常见问题处理

### 8.1 回退操作

```bash
# 查看操作历史（用于找回丢失的提交）
git reflog

# 回退到某个提交（保留工作区修改）
git reset --soft HEAD~1

# 回退到某个提交（保留工作区修改，清空暂存区）
git reset HEAD~1
# 或
git reset --mixed HEAD~1

# 回退到某个提交（丢弃所有修改，危险！）
git reset --hard HEAD~1

# 创建一个新提交来撤销之前的提交（安全，推荐用于已推送的提交）
git revert commit-hash
```

### 8.2 暂存工作区（Stash）

```bash
# 临时保存当前工作（切换分支前常用）
git stash

# 保存时添加说明
git stash save "正在开发登录功能"

# 查看暂存列表
git stash list

# 恢复最近的暂存
git stash pop

# 恢复指定的暂存
git stash apply stash@{1}

# 删除暂存
git stash drop stash@{0}

# 清空所有暂存
git stash clear
```

### 8.3 修改历史提交

```bash
# 修改最后一次提交信息
git commit --amend -m "新的提交信息"

# 交互式修改最近 3 次提交
git rebase -i HEAD~3

# 在编辑器中可以：
# pick   - 保留提交
# reword - 修改提交信息
# edit   - 修改提交内容
# squash - 合并到上一个提交
# drop   - 删除提交
```

### 8.4 找回丢失的代码

```bash
# 查看所有操作记录
git reflog

# 找到丢失提交的 hash，然后
git checkout <commit-hash>

# 或创建新分支保存
git checkout -b recovery-branch <commit-hash>
```

### 8.5 处理大文件

```bash
# 如果不小心提交了大文件，需要从历史中删除
# 使用 BFG 或 git-filter-repo 工具

# 配置 .gitignore 防止再次提交
echo "*.zip" >> .gitignore
echo "node_modules/" >> .gitignore
git add .gitignore
git commit -m "更新 gitignore"
```

---

## 9. 最佳实践

### 9.1 提交信息规范

推荐使用 **Conventional Commits** 规范：

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type 类型：**

| 类型 | 说明 |
|------|------|
| feat | 新功能 |
| fix | Bug 修复 |
| docs | 文档更新 |
| style | 代码格式（不影响功能） |
| refactor | 重构 |
| test | 测试相关 |
| chore | 构建/工具/辅助 |

**示例：**

```bash
git commit -m "feat(user): 添加用户登录功能"
git commit -m "fix(auth): 修复 token 过期不刷新的问题"
git commit -m "docs: 更新 API 文档"
git commit -m "refactor: 优化数据库查询性能"
```

### 9.2 分支命名规范

```
feature/功能名称     # 功能分支
bugfix/问题描述      # Bug修复
hotfix/紧急修复      # 紧急修复
release/版本号       # 发版分支

# 示例
feature/user-login
feature/order-export
bugfix/login-validation
hotfix/security-patch
release/v1.2.0
```

### 9.3 .gitignore 配置

```gitignore
# IDE
.idea/
.vscode/
*.iml

# 编译输出
target/
build/
dist/
*.class

# 依赖目录
node_modules/
vendor/

# 日志
*.log
logs/

# 系统文件
.DS_Store
Thumbs.db

# 环境配置（包含敏感信息）
.env
.env.local
*.properties

# 临时文件
*.tmp
*.swp
```

### 9.4 其他建议

1. **频繁提交**：每完成一个小功能就提交，不要积攒
2. **先拉后推**：推送前先 `git pull --rebase`
3. **写好提交信息**：未来的你会感谢现在的你
4. **善用分支**：不要直接在 main/develop 上开发
5. **定期清理**：删除已合并的本地分支
6. **不要提交敏感信息**：密码、密钥等使用环境变量

---

## 10. 常用命令速查表

### 基础命令

| 命令 | 说明 |
|------|------|
| `git init` | 初始化仓库 |
| `git clone <url>` | 克隆仓库 |
| `git status` | 查看状态 |
| `git add <file>` | 添加到暂存区 |
| `git add .` | 添加所有文件 |
| `git commit -m "msg"` | 提交 |
| `git log` | 查看历史 |
| `git diff` | 查看差异 |

### 分支命令

| 命令 | 说明 |
|------|------|
| `git branch` | 查看分支 |
| `git branch <name>` | 创建分支 |
| `git checkout <branch>` | 切换分支 |
| `git checkout -b <name>` | 创建并切换 |
| `git merge <branch>` | 合并分支 |
| `git branch -d <name>` | 删除分支 |

### 远程命令

| 命令 | 说明 |
|------|------|
| `git remote -v` | 查看远程仓库 |
| `git push` | 推送 |
| `git pull` | 拉取 |
| `git fetch` | 获取（不合并） |
| `git push -u origin <branch>` | 推送并建立追踪 |

### 撤销命令

| 命令 | 说明 |
|------|------|
| `git checkout -- <file>` | 撤销工作区修改 |
| `git reset HEAD <file>` | 取消暂存 |
| `git reset --hard HEAD~1` | 回退提交 |
| `git revert <commit>` | 撤销提交（新建提交） |
| `git stash` | 暂存工作区 |
